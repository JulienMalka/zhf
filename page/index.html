<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ZHF</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <h1><img src="nix-snowflake.svg">ZERO Hydra Failures</h1>
    <table class="compact">
      <tbody class="no-stripes">
        <tr><td>Current ZHF target:</td><td><b>@targetbranch@</b></td></tr>
        <tr><td>Last check:</td><td><b>@lastcheck@</b></td></tr>
        <tr><td>Next check:</td><td><img alt="pipeline status" src="https://git.helsinki.tools/janne.hess/zhf/badges/master/pipeline.svg" /></td></tr>
        <tr></tr>
        <tr><td>Latest Linux evaluation (completely built):</td><td><a href="https://hydra.nixos.org/eval/@lastlinuxevalno@"><b>@lastlinuxevalno@</b></a> on <b>@lastlinuxevaltime@</b></td></tr>
        <tr><td>Latest Darwin evaluation (completely built):</td><td><a href="https://hydra.nixos.org/eval/@lastdarwinevalno@"><b>@lastdarwinevalno@</b></a> on <b>@lastdarwinevaltime@</b></td></tr>
        <tr></tr>
        @failingbuildstable@
        <tr><td>Total failed builds</td><td><b>@totalbuildfailures@</b></td></tr>
      </tbody>
    </table>
    <div id="burndown-container">
      <canvas id="burndown"></canvas>
    </div>
    <h2>Failed builds</h2>
    <ul>
      <li><a href="failed/by-maintainer/_.html">Failed without maintainer</a></li>
      <li><a href="failed/all.html">All failed builds</a></li>
      <li><a href="failed/overview.html">Failed by maintainer</a></li>
    </ul>
    <h2>Most problematic dependencies</h2>
    <table>
        <thead><tr><th>Number of dependants</th><th>Job</th></tr></thead>
        <tbody>
          @mostproblematicdeps@
        </tbody>
    </table>
    <!-- TODO don't get from a CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@^2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@^1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
    <script>

      var data = {
        datasets: [{
            label: 'Linux Failures',
            borderColor: '#4d6fb6',
            lineTension: 0,
            data: [@linuxburndown@]
        }, {
            label: 'Darwin Failures',
            borderColor: '#7eb6e1',
            lineTension: 0,
            data: [@darwinburndown@]
        }],
      };

      new Chart(document.getElementById('burndown'), {
        type: 'line',
        data: data,
        options: {
          maintainAspectRatio: false,
          interaction: {
            mode: 'nearest',
            intersect: false
          },
          animation: {
            duration: 0,
          },
          responsiveAnimationDuration: 0,
          scales: {
            xAxis: {
              type: 'time',
              adapters: {
                time: {
                  zone: 'UTC',
                },
              },
              distribution: 'series',
              min: new Date(new Date().setDate(new Date().getDate()-14)), // 14 days ago
              suggestedMax: '2022-06-01T00:00:00'
            },
            yAxis: {
              ticks: {
                min: 0
              }
            }
          },
          plugins: {
            autocolors: false,
            legend: {
              display: true,
              position: 'bottom'
            },
            annotation: {
              annotations: {
                today: {
                  type: 'line',
                  value: new Date(),
                  borderColor: 'red',
                  borderWidth: 2,
                  scaleID: 'xAxis',
                  label: {
                    enabled: true,
                    content: 'Now',
                    position: 'end'
                  }
                },
                featurefreeze: {
                  type: 'line',
                  value: '2022-05-01T00:00:00',
                  borderColor: 'green',
                  borderWidth: 2,
                  borderDash: [5,5],
                  scaleID: 'xAxis',
                  label: {
                    enabled: true,
                    content: 'Feature Freeze',
                    position: 'start'
                  }
                },
                zhf: {
                  type: 'line',
                  value: '2022-05-08T00:00:00',
                  borderColor: 'green',
                  borderWidth: 2,
                  borderDash: [5,5],
                  scaleID: 'xAxis',
                  label: {
                    enabled: true,
                    content: 'ZHF',
                    position: 'start'
                  }
                },
                branchoff: {
                  type: 'line',
                  value: '2022-05-22T00:00:00',
                  borderColor: 'green',
                  borderWidth: 2,
                  borderDash: [5,5],
                  scaleID: 'xAxis',
                  label: {
                    enabled: true,
                    content: 'Branch-off',
                    position: 'start'
                  }
                },
                release: {
                  type: 'line',
                  value: '2022-05-30T00:00:00',
                  borderColor: 'green',
                  borderWidth: 2,
                  borderDash: [5,5],
                  scaleID: 'xAxis',
                  label: {
                    enabled: true,
                    content: 'Release',
                    position: 'start',
                  }
                }
              }
            }
          }
        }
      });
    </script>
  </body>
</html>
